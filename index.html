<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简发卡系统</title>
    <style>
        /* 保持原有样式不变 */
        :root {
            --primary: #1890ff;
            --success: #52c41a;
            --error: #f5222d;
            --bg: #f0f2f5;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            margin: 0;
            min-height: 100vh;
            background: var(--bg);
        }

        /* 前台样式 */
        .frontend {
            max-width: 500px;
            margin: 20px auto;
            padding: 20px;
        }

        /* 后台样式 */
        .backend {
            display: none;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .admin-nav button {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            background: #e0e0e0;
        }

        .admin-nav button.active {
            background: var(--primary);
            color: white;
        }

        .admin-panel {
            display: none;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .admin-panel.active {
            display: block;
        }

        /* 公共样式 */
        .input-field {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
        }

        #adminEntry {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 100;
        }

        .copy-btn {
            background: var(--success);
            color: white;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <!-- 前台界面 -->
    <div class="frontend">
        <h2>短信任务发卡系统</h2>
        <input type="tel" id="phone" class="input-field" placeholder="手机号码" pattern="\d{11}">
        
        <div style="margin:20px 0">
            <h3>任务1：发送短信1到指定号码</h3>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="System.sendSMS(1)">发送短信</button>
                <button class="btn btn-primary" id="getCode1" onclick="System.getCode(1)" disabled>获取验证码</button>
            </div>
            <input type="text" id="code1" class="input-field" placeholder="验证码" disabled style="margin-top:10px">
        </div>

        <div style="margin:20px 0">
            <h3>任务2：发送短信注册QQ</h3>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="System.sendSMS(2)">发送短信</button>
                <button class="btn btn-primary" id="getCode2" onclick="System.getCode(2)" disabled>获取验证码</button>
            </div>
            <input type="text" id="code2" class="input-field" placeholder="验证码" disabled style="margin-top:10px">
            <!-- 新增提交按钮 -->
            <button id="submitBtn" class="btn btn-primary" onclick="System.submitCodes()" style="margin-top:10px;display:none">提交验证领取卡密</button>
        </div>

        <!-- 修改后的卡密显示区域 -->
        <div id="cardResult" style="display:none">
            <h3>卡密领取成功！</h3>
            <div id="cardContent" style="display:none"></div>
            <button class="btn copy-btn" onclick="System.copyCard()">点击复制卡密</button>
        </div>
    </div>

    <!-- 后台界面保持不变 -->
    <div class="backend">
        <!-- 保持原有后台结构不变 -->
    </div>

    <!-- 登录模态框保持不变 -->
    <div class="modal" id="loginModal">
        <!-- 保持原有登录框结构 -->
    </div>

    <button id="adminEntry" class="btn btn-primary" onclick="System.showLogin()">管理员登录</button>
    <button id="adminExit" class="btn btn-primary" style="display:none; position:fixed; top:20px; right:20px;" onclick="System.logout()">退出登录</button>

<script>
const System = (() => {
    const state = {
        currentPanel: 'users',
        codes: {},
        timers: {},
        currentCard: null // 新增当前卡密存储
    };

    // 初始化存储（保持不变）
    function initStorage() {
        if(!localStorage.admin) localStorage.admin = JSON.stringify({
            username: "admin",
            password: "admin123"
        });
        if(!localStorage.cards) localStorage.cards = JSON.stringify([]);
        if(!localStorage.users) localStorage.users = JSON.stringify({
            completed: [],
            pending: []
        });
    }

    // 新增提交验证方法
    function submitCodes() {
        const code1 = document.getElementById('code1').value;
        const code2 = document.getElementById('code2').value;
        const phone = document.getElementById('phone').value;

        if (!phone || !/^\d{11}$/.test(phone)) return alert('请先输入有效手机号');
        if (code1 != state.codes[1] || code2 != state.codes[2]) return alert('验证码错误');

        // 发放卡密
        const cards = JSON.parse(localStorage.cards);
        if (cards.length === 0) return alert('卡密已发完');
        state.currentCard = cards.shift();
        localStorage.cards = JSON.stringify(cards);

        // 更新用户记录
        const users = JSON.parse(localStorage.users);
        users.pending = users.pending.filter(p => p !== phone);
        users.completed.push({ phone, card: state.currentCard });
        localStorage.users = JSON.stringify(users);

        // 显示结果
        document.getElementById('cardResult').style.display = 'block';
        refreshUsers();
    }

    // 修改后的复制功能
    function copyCard() {
        if (!state.currentCard) return alert('没有可复制的卡密');
        navigator.clipboard.writeText(state.currentCard).then(() => {
            alert('卡密已复制到剪贴板');
        });
    }

    // 修改短信发送函数
    function sendSMS(task) {
        const phone = document.getElementById('phone').value;
        if(!/^\d{11}$/.test(phone)) return alert('请输入有效手机号');
        
        // 记录未完成用户
        const users = JSON.parse(localStorage.users);
        if(!users.completed.some(u => u.phone === phone)) {
            users.pending.push(phone);
            localStorage.users = JSON.stringify(users);
            refreshUsers();
        }

        // 跳转短信
        window.location.href = `sms:106988881700511?body=${task === 1 ? '1' : '注册QQ'}`;
        
        // 生成验证码
        setTimeout(() => {
            const code = Math.floor(100000 + Math.random() * 900000);
            state.codes[task] = code;
            alert(`测试验证码：${code}`);
            document.getElementById(`code${task}`).disabled = false;
            
            // 任务2发送后显示提交按钮
            if(task === 2) {
                document.getElementById('submitBtn').style.display = 'inline-block';
            }
        }, 1000);
    }

    // 保持其他原有方法不变
    return {
        init: () => {
            initStorage();
            document.getElementById('phone').addEventListener('input', function(e) {
                const isValid = /^\d{11}$/.test(e.target.value);
                this.style.borderColor = isValid ? '#ddd' : 'var(--error)';
            });
        },
        showLogin: () => document.getElementById('loginModal').style.display = 'flex',
        hideLogin: () => document.getElementById('loginModal').style.display = 'none',
        doLogin,
        logout,
        showPanel,
        addCards,
        changePassword,
        sendSMS,
        copyCard,
        submitCodes // 暴露新方法
    };
})();

// 初始化系统
document.addEventListener('DOMContentLoaded', System.init);
</script>
</body>
</html>
